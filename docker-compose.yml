services:
  backstage-application:
    container_name: backstage-application
    build:
      context: ./src/
      dockerfile: ../ops/docker/application/Dockerfile
      target: runtime
    env_file:
      - .env
    environment:
      POSTGRES_HOST: backstage-postgres
      POSTGRES_USER: backstage
      POSTGRES_PASSWORD: backstage
      POSTGRES_DB: backstage
    depends_on:
      backstage-postgres:
        condition: service_healthy
    volumes:
      - ./src/app-config.yaml:/app/app-config.yaml:ro
      - ./src/catalog:/app/catalog:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "3000:3000"
      - "7007:7007"

  backstage-postgres:
    container_name: backstage-postgres
    image: webgrip/backstage-application-postgres:latest
    build:
      context: ops/docker/postgresql
      dockerfile: Dockerfile
    volumes:
      - ./ops/postgresql/docker-entrypoint-initdb:/docker-entrypoint-initdb.d/
      - postgres-data:/var/lib/postgresql
    environment:
      POSTGRES_USER: backstage
      POSTGRES_PASSWORD: backstage
      POSTGRES_DB: backstage
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U backstage -d backstage"]
      interval: 10s
      timeout: 5s
      retries: 5
#
#  structurizr:
#    container_name: structurizr
#    image: structurizr/lite:latest
#    volumes:
#      - ./docs/structurizr/config:/usr/local/structurizr/config:ro
#      - ./docs/structurizr/workspace:/usr/local/structurizr/workspace
#    ports:
#      - "9998:8080"
#    environment:
#      - SPRING_PROFILES_ACTIVE=custom-profile
#      - STRUCTURIZR_WORKSPACE_PATH=workspace
#    command: ["java", "--enable-native-access=ALL-UNNAMED", "--add-modules=jdk.incubator.vector", "-jar", "/usr/local/structurizr-lite.war"]

networks:
  default:
    external: true
    name: webgrip

volumes:
  postgres-data:
